<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Character Encoding and Viewport -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- Page Title and Favicon -->
  <title>SOLD OUT! Comedy</title>
  <link rel="icon" type="image/png" href="web/images/soldoutlogo.png">

  <!-- Google Fonts: Bangers (comic book style) and Inter (body text) -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Bangers:wght@400&family=Inter:wght@300;400;600;700&display=swap">

  <!-- Main Stylesheet -->
  <link rel="stylesheet" href="web/style.css">
</head>
<body>
  <!-- Legacy overlay element (currently hidden) -->
  <div class="halftone-overlay"></div>

  <!-- ================================================
       HERO SECTION - Top of page with logo and tagline
       ================================================ -->
  <section class="hero">
    <!-- Dynamic tagline loaded from taglines.xml via JavaScript -->
    <p class="hero-subtitle">Live Comedy Meets Live Shopping</p>

    <!-- Main logo -->
    <img src="web/images/soldoutlogo.png" alt="SOLD OUT! Comedy" class="hero-logo">

    <!-- Main description with example link -->
    <div class="hero-description">
      Live selling is a $68 billion market, but let's be real, <a href="https://www.reddit.com/r/whatnotapp/comments/1ntac3q/once_again_crashout_on_whatnot_pt1/?utm_source=share&utm_medium=web3x&utm_name=web3xcss&utm_term=1&utm_content=share_button" target="_blank" rel="noopener noreferrer" style="color: var(--comic-red); font-weight: 700; text-decoration: underline;">it's painful to watch</a>. We're changing that. Give us that dusty juicer to sell and it becomes a prop in an improv sketch while the live and online audiences both bid on it. We'll sell out our dignity to sell out your stuff.
    </div>

    <!-- ================================================
         EDITION CARDS - Stage and Screen descriptions
         ================================================ -->
    <div class="two-cards">
      <!-- STAGE EDITION CARD -->
      <div class="edition-card stage-edition">
        <h3>Stage Edition</h3>
        <div class="subtitle">Live-In-Person and Online Audiences</div>
        <p>Full theatrical improv where YOUR items become props in hilarious sketches. Bring something to sell, watch comedians transform it on stage, and let both live and online audiences battle it out in the bidding war. That bread maker? It's about to become a flux capacitor.</p>
        <div class="themes-section">
          <h4>Stage Edition Features</h4>
          <ul class="themes-list">
            <li>Phones encouraged (bid, chat, scroll through Reddit!)</li>
            <li>Online + in-person audiences together</li>
            <li>Your junk becomes comedy gold</li>
          </ul>
        </div>
      </div>

      <!-- SCREEN EDITION CARD -->
      <div class="edition-card screen-edition">
        <h3>Screen Edition</h3>
        <div class="subtitle">Online Audience Only</div>
        <p>Join us online/live for skits where we try and sell you a random pile of socks we impulse-bought from Temu at 2 AM. Baby needs a new pair of shoes! -Baby already has plenty of socks.</p>
        <div class="themes-section">
          <h4>Upcoming Themes</h4>
          <ul class="themes-list">
            <li>Socks (Yes, we're serious about the socks.)</li>
            <li>Home Goods Gems</li>
            <li>The Junk in the Trunk Show</li>
          </ul>
        </div>
      </div>
    </div>

  </section>

  <!-- ================================================
       SCHEDULE SECTION - Dynamically loaded shows
       ================================================ -->
  <section style="background: #FFFFFF; position: relative; z-index: 9999; padding: var(--section-padding); margin: var(--section-gap) 0;">
    <div class="schedule-section" style="margin: 0 auto; padding: 0;">
      <h2>SOLD OUT! Shows</h2>
      <p>Tickets Still Available</p>
      <!-- Schedule loaded from shows.xml via JavaScript -->
      <div id="schedule-container"></div>
    </div>
  </section>

  <section class="hero" style="padding-top: 0;">

    <!-- ================================================
         FAKE REVIEWS SECTION - Humorous video testimonials
         ================================================ -->
    <section class="reviews-section">
      <h2 class="section-title">The Fake Reviews Are In</h2>
      <div class="reviews-grid">
        <!-- Each review card contains a looping video and review bubble -->
        <div class="review-card">
          <video src="web/images/comicsansguy.mp4" alt="Jorge B." class="review-photo" autoplay loop muted playsinline></video>
          <div class="review-content">
            <div class="stars"><span class="filled-star">â˜…</span><span class="empty-star">â˜…â˜…â˜…â˜…</span></div>
            <p class="review-text">"I can't believe they didn't use Comic Sans on their website. It seems like a website that would have Comic Sans on it."</p>
            <div class="reviewer">- Jorge B.</div>
          </div>
        </div>
        <div class="review-card">
          <video src="web/images/traderjoes.mp4" alt="Confused Customer" class="review-photo" autoplay loop muted playsinline></video>
          <div class="review-content">
            <div class="stars"><span class="filled-star">â˜…â˜…â˜…</span><span class="empty-star">â˜…â˜…</span></div>
            <p class="review-text">"I thought I was going to Trader Joe's"</p>
            <div class="reviewer">- Confused Customer</div>
          </div>
        </div>
        <div class="review-card">
          <video src="web/images/banana.mp4" alt="Fruit Enthusiast" class="review-photo" autoplay loop muted playsinline></video>
          <div class="review-content">
            <div class="stars"><span class="filled-star">â˜…â˜…</span><span class="empty-star">â˜…â˜…â˜…</span></div>
            <p class="review-text">"They sold me a banana for $47. It wasn't even ripe."</p>
            <div class="reviewer">- Fruit Enthusiast</div>
          </div>
        </div>
        <div class="review-card">
          <video src="web/images/knives.mp4" alt="Sharp Shopper" class="review-photo" autoplay loop muted playsinline></video>
          <div class="review-content">
            <div class="stars"><span class="filled-star">â˜…â˜…â˜…</span><span class="empty-star">â˜…â˜…</span></div>
            <p class="review-text">"I came for the improv but left with 12 kitchen knives. Still confused. -and stop counting the knives in the butcher block. You're taking this way too seriously."</p>
            <div class="reviewer">- Sharp Shopper</div>
          </div>
        </div>
        <div class="review-card">
          <video src="web/images/treadmill.mp4" alt="Concerned Grandchild" class="review-photo" autoplay loop muted playsinline></video>
          <div class="review-content">
            <div class="stars"><span class="filled-star">â˜…â˜…â˜…â˜…</span><span class="empty-star">â˜…</span></div>
            <p class="review-text">"My grandmother swiped wrong during the show and bought a treadmill. She's 94."</p>
            <div class="reviewer">- Concerned Grandchild</div>
          </div>
        </div>
        <div class="review-card">
          <video src="web/images/rainman.mp4" alt="Raymond Babbitt" class="review-photo" autoplay loop muted playsinline></video>
          <div class="review-content">
            <div class="stars"><span class="filled-star">â˜…</span><span class="empty-star">â˜…â˜…â˜…â˜…</span></div>
            <p class="review-text">"Charlie Babbitt squeezed and pulled and hurt my neck in 1988"</p>
            <div class="reviewer">- Raymond Babbitt</div>
          </div>
        </div>
        <div class="review-card">
          <video src="web/images/floyd.mp4" alt="Floyd" class="review-photo" autoplay loop muted playsinline></video>
          <div class="review-content">
            <div class="stars"><span class="filled-star">â˜…</span><span class="empty-star">â˜…â˜…â˜…â˜…</span></div>
            <p class="review-text">"If tickets are still available, you can't be sold out! How can you be sold out if tickets are still available?!"</p>
            <div class="reviewer">- Pink Floyd Fan</div>
          </div>
        </div>
        <div class="review-card">
          <video src="web/images/shakespeare.mp4" alt="Theater Critic" class="review-photo" autoplay loop muted playsinline></video>
          <div class="review-content">
            <div class="stars"><span class="filled-star">â˜…â˜…â˜…</span><span class="empty-star">â˜…â˜…</span></div>
            <p class="review-text">"Was expecting Shakespeare. Got a guy selling tube socks. Honestly? Not disappointed."</p>
            <div class="reviewer">- Theater Critic</div>
          </div>
        </div>
      </div>
    </section>

    <!-- ================================================
         CTA SECTION - Comic burst with animated tagline
         ================================================ -->
    <div class="cta-section">
      <div class="burst-wrap">
        <!-- SVG comic burst shape with drop shadow -->
        <svg class="burst-svg" viewBox="0 0 1200 600" role="img" aria-label="Comic burst">
          <defs>
            <filter id="comicShadow" x="-20%" y="-20%" width="140%" height="140%">
              <feDropShadow dx="12" dy="12" stdDeviation="4" flood-color="#000" flood-opacity="0.4"/>
            </filter>
          </defs>
          <path d="M600 40  690 120 820 60 770 170 1080 210 820 250
                   1140 340 780 330 910 520 640 400 600 560 560 400
                   290 520 420 330 60 340 380 250 120 210 430 170
                   380 60 510 120 Z"
                fill="#FFD93D" stroke="#2C2C2C" stroke-width="24" stroke-linejoin="round"
                filter="url(#comicShadow)"/>
        </svg>
        <!-- Overlaid tagline text with pulse animation -->
        <div class="tagline">SELL OUT WITH US.</div>
      </div>
    </div>
  </section>

  <!-- ================================================
       COMIC FRAME VIDEO SECTION - Random video player
       ================================================ -->
  <section class="comic-frame-section">
    <div class="comic-frame-container">
      <video id="comicFrameVideo" class="comic-frame-video" autoplay loop muted playsinline></video>
      <button id="videoUnmuteBtn" class="video-unmute-btn" aria-label="Toggle sound">ðŸ”‡</button>
    </div>
  </section>

  <!-- ================================================
       FOOTER - Social links and copyright
       ================================================ -->
  <footer id="contact">
    <div class="footer-content">
      <!-- Social media icon grid with random rotations applied via JS -->
      <div class="social-links">
        <a href="https://www.instagram.com/soldout.comedy" class="social-link" title="Instagram">
          <img src="web/images/instagram_logo.svg" alt="Instagram" style="width: 70%; height: 70%; object-fit: contain;">
        </a>
        <a href="https://www.facebook.com/profile.php?id=61578903020598" class="social-link" title="Facebook">
          <img src="web/images/facebook_logo.png" alt="Facebook" style="width: 70%; height: 70%; object-fit: contain;">
        </a>
        <a href="https://x.com/soldoutcomedy" class="social-link" title="X">
          <img src="web/images/x_logo.png" alt="X" style="width: 60%; height: 60%; object-fit: contain; filter: invert(1);">
        </a>
        <a href="https://www.youtube.com/@SOLDOUTComedy" class="social-link" title="YouTube">
          <img src="web/images/yt_logo.png" alt="YouTube" style="width: 60%; height: 60%; object-fit: contain;">
        </a>
        <a href="https://www.tiktok.com/@sold.out.comedy" class="social-link" title="TikTok">
          <img src="web/images/tiktok_logo.png" alt="TikTok" style="width: 60%; height: 60%; object-fit: contain;">
        </a>
        <a href="https://poshmark.com/closet/soldoutcomedy" class="social-link" title="Poshmark">
          <img src="web/images/poshmark_logo.png" alt="Poshmark" style="width: 70%; height: 70%; object-fit: contain;">
        </a>
        <a href="https://www.whatnot.com/user/soldoutcomedy" class="social-link" title="Whatnot">
          <img src="web/images/whatnot.jpg" alt="Whatnot" style="width: 70%; height: 70%; object-fit: contain;">
        </a>
        <a href="https://www.pretzels.com/collections/all" class="social-link" title="Pretzels">
          <img src="https://cdn.shopify.com/s/files/1/0562/4332/3051/files/f16a5d2567b5cc3589e3a0de5804979e9696a88a.png?v=1756135246" alt="Pretzels" style="width: 70%; height: 70%; object-fit: contain;">
        </a>
        <a href="https://soldoutcomedy.bsky.social" class="social-link" title="Blue Sky">
          <img src="web/images/Bluesky_Logo.svg" alt="Blue Sky" style="width: 70%; height: 70%; object-fit: contain;">
        </a>
        <a href="https://www.threads.com/@soldout.comedy?hl=en" class="social-link" title="Threads">
          <img src="web/images/threads_logo.png" alt="Threads" style="width: 70%; height: 70%; object-fit: contain;">
        </a>
        <a href="https://www.reddit.com/user/SOLDOUTComedy/submitted/" class="social-link" title="Reddit">
          <svg viewBox="0 0 24 24" style="width: 70%; height: 70%;" fill="#FF4500">
            <path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/>
          </svg>
        </a>
      </div>
      <div class="copyright">
        <p>&copy; 2025 SOLD OUT! Comedy</p>
      </div>
    </div>
  </footer>

  <!-- ================================================
       SECONDARY FOOTER - Legal/informational links
       ================================================ -->
  <footer class="boring-footer">
    <div class="boring-footer-content">
      <a href="https://backstage.soldoutcomedy.com">BACKSTAGE</a>
      <span class="separator">|</span>
      <a href="https://help.whatnot.com/hc/en-us/articles/360061224972-Prohibited-or-Restricted-Items-on-Whatnot" target="_blank" rel="noopener noreferrer">PROHIBITED ITEMS</a>
      <span class="separator">|</span>
      <a href="https://news.uchicago.edu/explainer/improv-explained" target="_blank" rel="noopener noreferrer">IMPROV EXPLAINED</a>
    </div>
  </footer>

  <!-- ================================================
       IMAGE LIGHTBOX - Full-screen image viewer
       ================================================ -->
  <div class="image-lightbox" id="imageLightbox">
    <img src="" alt="Full size image">
  </div>

  <!-- ================================================
       CONSIGNMENT GUIDELINES MODAL - Terms popup
       ================================================ -->
  <div class="modal-overlay" id="consignmentModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Consignment Guidelines</h2>
        <button class="modal-close" id="closeModal">&times;</button>
      </div>
      <div class="modal-body">
        <h3>How It Works</h3>
        <p><strong>Auction Format:</strong> Your item will be auctioned during a SOLD OUT! Comedy Show in a format determined by our production team. Think of it as consignment theaterâ€”we provide the audience and entertainment, you provide the props!</p>

        <h3>Pricing & Payment</h3>
        <ul>
          <li><strong>Net Price:</strong> You set the amount you're willing to receive for your item</li>
          <li><strong>Listing Price:</strong> We set the listing price, which includes all taxes, fees, shipping, and handling costs</li>
          <li><strong>Our Cut:</strong> Any amount received above your Net Price belongs to SOLD OUT! Comedy</li>
          <li><strong>Payment:</strong> If your item sells, you receive exactly your Net Price within 3 days of sale</li>
        </ul>

        <h3>Check-In Process</h3>
        <ul>
          <li>Bring your item in an unsealed, mail-ready box</li>
          <li>Arrive no earlier than one hour before showtime</li>
          <li>Check in with our Appraiser to set your net price</li>
          <li>You can choose to participate in selling your item or watch from your seat</li>
        </ul>

        <h3>During the Show</h3>
        <ul>
          <li>Comedians use your items as props in improv scenes</li>
          <li>You never know when or if your prop will pop up!</li>
          <li>If it isn't used in a skit, it will be auctioned during the Lightning Round</li>
          <li>The production team has final say on item participation and usage</li>
        </ul>

        <h3>If Your Item Doesn't Sell</h3>
        <ul>
          <li>We'll return it to you after the show (our goal is immediate, in-person return)</li>
          <li>Official policy: returned within 14 days at consignor's expense</li>
        </ul>

        <h3>Important Terms</h3>
        <ul>
          <li><strong>Condition:</strong> You warrant the item is as described and you have clear title to sell</li>
          <li><strong>Final Sales:</strong> All sales are finalâ€”no returns or refunds permitted. No takesy backsies!</li>
          <li><strong>Liability:</strong> You release SOLD OUT! Comedy from any liability related to your item, its sale, or your participation</li>
          <li><strong>Promotion:</strong> You grant permission to photograph and promote the item across all media platforms</li>
        </ul>

        <p style="margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid #f0f0f0; font-size: 0.9rem; color: #666;">
          Ready to consign? Check in with our Appraiser when you arrive at the show, or visit our <a href="props/input.html" style="color: var(--comic-red); font-weight: 600;">Prop Check-In form</a> to get started.
        </p>
      </div>
    </div>
  </div>

<script>
/* ================================================
   JAVASCRIPT INITIALIZATION
   ================================================ */

/**
 * Main initialization function - runs when DOM is fully loaded
 * Initializes all dynamic content and interactive features
 */
document.addEventListener('DOMContentLoaded', () => {
  loadRandomTagline();       // Load random tagline from XML
  randomizeSocialIconTilts(); // Randomize social icon rotations
  loadSchedule();             // Load show schedule from XML
  initConsignmentModal();     // Initialize modal popup
  initImageLightbox();        // Initialize image zoom lightbox
  loadRandomVideo();          // Load random video in comic frame
  initVideoUnmuteButton();    // Initialize video mute/unmute button
});

/* ================================================
   HELPER FUNCTIONS
   ================================================ */

/**
 * Creates a logging function for debugging
 * @param {HTMLElement} targetEl - The element being worked on
 * @param {string} id - Identifier for log messages
 * @param {boolean} above - Unused legacy parameter
 * @returns {Function} - Logger function
 */
function makeStatusLine(targetEl, id, above = true) {
  return (msg) => { console.log(`[SOLD OUT][${id}]`, msg); };
}

/**
 * Applies random rotation to social media icons for comic book feel
 */
function randomizeSocialIconTilts() {
  const socialLinks = document.querySelectorAll('.social-link');
  socialLinks.forEach(link => {
    const randomTilt = (Math.random() - 0.5) * 30; // -15deg to +15deg
    link.style.transform = `rotate(${randomTilt}deg)`;
  });
}

/**
 * Tries multiple URLs and returns the first one that works
 * Used to handle different deployment paths (local, subdirectory, etc.)
 * @param {string[]} candidates - Array of URLs to try
 * @param {string} idForLogs - Identifier for logging
 * @returns {Promise<string>} - Response text from first successful fetch
 */
async function fetchFirstWorking(candidates, idForLogs) {
  let lastErr;
  for (const url of candidates) {
    try {
      const res = await fetch(url, { cache: 'no-cache' });
      if (!res.ok) {
        console.warn(`[${idForLogs}] ${url} -> HTTP ${res.status}`);
        continue;
      }
      const text = await res.text();
      console.info(`[${idForLogs}] loaded from ${url}`);
      return text;
    } catch (e) {
      console.warn(`[${idForLogs}] ${url} failed`, e);
      lastErr = e;
    }
  }
  throw lastErr || new Error('No candidate URL worked.');
}

/* ================================================
   TAGLINE LOADER
   ================================================ */

/**
 * Loads a random tagline from taglines.xml and displays it
 * Falls back to default tagline if loading fails
 */
async function loadRandomTagline() {
  const el = document.querySelector('.hero-subtitle');
  if (!el) return;

  const status = makeStatusLine(el, 'taglines-debug');

  // Check if running from file:// protocol (won't work due to CORS)
  if (location.protocol === 'file:') {
    status('Cannot load taglines.xml over file:// â€” run a local server (e.g., "npx serve").');
    el.textContent = 'Live Comedy Meets Live Shopping';
    return;
  }

  // Try multiple paths to find taglines.xml
  const candidates = [
    'web/taglines.xml',
    './taglines.xml',
    '../web/taglines.xml'
  ];

  try {
    // Fetch and parse XML
    const xmlText = await fetchFirstWorking(candidates, 'taglines');
    const doc = new DOMParser().parseFromString(xmlText, 'text/xml');
    const parseErr = doc.querySelector('parsererror');

    // Check for XML parsing errors
    if (parseErr) {
      status('taglines.xml parser error â€” check console');
      console.error('[taglines] parsererror:', parseErr.textContent);
      el.textContent = 'Live Comedy Meets Live Shopping';
      return;
    }

    // Extract all tagline elements
    const items = [...doc.querySelectorAll('taglines > tagline')]
      .map(n => n.textContent?.trim())
      .filter(Boolean);

    // Validate we have taglines
    if (!items.length) {
      status('taglines.xml loaded, but no <tagline> items found');
      el.textContent = 'Live Comedy Meets Live Shopping';
      return;
    }

    // Pick a random tagline and display it
    const choice = items[Math.floor(Math.random() * items.length)];
    el.textContent = choice;
    status(`Loaded ${items.length} taglines`);
  } catch (err) {
    // Fallback to default tagline on any error
    status('Failed to load taglines (see console)');
    console.error('[taglines] load failed:', err);
    el.textContent = 'Live Comedy Meets Live Shopping';
  }
}

/* ================================================
   SCHEDULE LOADER
   ================================================ */

/**
 * Loads show schedule from shows.xml and renders it dynamically
 * Handles both upcoming and past shows, creates calendar links
 */
async function loadSchedule() {
  const container = document.getElementById('schedule-container');
  if (!container) return;

  const status = makeStatusLine(container, 'schedule-debug');

  // Default URLs
  const ADD_TO_CAL = 'https://cnn.com'; // Legacy fallback
  const WATCH_URL = 'https://www.whatnot.com/user/soldoutcomedy';

  // Check if running from file:// protocol
  if (location.protocol === 'file:') {
    status('Cannot load shows.xml over file:// â€” run a local server (e.g., "npx serve").');
    container.innerHTML = '<p style="text-align:center;font-weight:600">More Shows Coming Soon</p>';
    return;
  }

  // Try multiple paths to find shows.xml
  const candidates = [
    'web/shows.xml',
    './shows.xml',
    '../web/shows.xml'
  ];

  /* ------ DATE/TIME UTILITY FUNCTIONS ------ */

  /**
   * Parses ISO 8601 datetime string to Date object
   * @param {string} datetimeStr - ISO datetime string
   * @returns {Date|null} - Parsed date or null if invalid
   */
  function parseUTCDateTime(datetimeStr) {
    if (!datetimeStr) return null;
    const dt = new Date(datetimeStr);
    return isNaN(dt.getTime()) ? null : dt;
  }

  /**
   * Extracts timezone abbreviation from date (e.g., PST, EST)
   * @param {Date} date - Date object
   * @returns {string} - Timezone abbreviation
   */
  function getTimezoneAbbr(date) {
    const str = date.toLocaleTimeString('en-US', { timeZoneName: 'short' });
    const match = str.match(/\b([A-Z]{3,5})\b/);
    return match ? match[1] : '';
  }

  /**
   * Formats date as "Monday, January 1"
   */
  const fmtDate = (d) => d?.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }) || '';

  /**
   * Formats time with optional timezone (e.g., "7:00 pm PST")
   * @param {Date} d - Date object
   * @param {boolean} includeTZ - Whether to include timezone
   * @returns {string} - Formatted time string
   */
  const fmtTime = (d, includeTZ = true) => {
    if (!d) return '';
    const time = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }).toLowerCase();
    if (!includeTZ) return time;
    const tz = getTimezoneAbbr(d);
    return `${time} ${tz}`;
  };

  /**
   * Parses appraisal time range (format: "2024-01-01T10:00Z - 2024-01-01T11:00Z")
   * @param {string} appraisalStr - Appraisal time range string
   * @returns {Object|null} - Object with start/end dates or null
   */
  function parseAppraisalTimes(appraisalStr) {
    if (!appraisalStr) return null;
    const parts = appraisalStr.split(' - ').map(s => s.trim());
    if (parts.length !== 2) return null;
    const start = parseUTCDateTime(parts[0]);
    const end = parseUTCDateTime(parts[1]);
    if (!start || !end) return null;
    return { start, end };
  }

  /**
   * Generates a Google Calendar "Add Event" link for a show
   * @param {Object} show - Show object with start, end, type, venue, etc.
   * @returns {string} - Google Calendar URL
   */
  function makeGoogleCalendarLink(show) {
    if (!show.start) return ADD_TO_CAL;

    // Calculate end time (use explicit end or estimate based on show type)
    let endTime;
    if (show.end) {
      endTime = show.end;
    } else {
      const durationHours = show.type === 'screen' ? 1 : 2;
      endTime = new Date(show.start.getTime() + (durationHours * 60 * 60 * 1000));
    }

    // Format date for Google Calendar (YYYYMMDDTHHmmss)
    const formatGCal = (d) => {
      const pad = (n) => String(n).padStart(2, '0');
      return `${d.getFullYear()}${pad(d.getMonth() + 1)}${pad(d.getDate())}T${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
    };

    // Build event title
    const title = `SOLD OUT! Comedy - ${show.type === 'stage' ? 'Stage Edition' : 'Screen Edition'}`;

    // Build location field
    const location = show.address || (show.type === 'screen' ? 'Online' : show.location || '');

    // Build detailed description
    let description = '';
    if (show.venue) description += `${show.venue}\n`;
    if (show.location && show.type === 'stage') description += `${show.location}\n`;
    if (show.type === 'stage' && show.appraisalTimes) {
      const apprStart = fmtTime(show.appraisalTimes.start, false);
      const apprEnd = fmtTime(show.appraisalTimes.end, false);
      description += `\nAppraisals: ${apprStart} - ${apprEnd}\n`;
    }
    if (show.watch) description += `\nWatch Live: ${show.watch}`;

    // Add show-type-specific description
    if (show.type === 'stage') {
      description += '\n\nLive comedy meets live shopping! Your items become props in improv scenes.';
    } else {
      description += '\n\nWatch and bid from the Whatnot app.';
    }

    description += '\n\nhttps://soldoutcomedy.com';

    // Build Google Calendar URL with query parameters
    const params = new URLSearchParams({
      action: 'TEMPLATE',
      text: title,
      dates: `${formatGCal(show.start)}/${formatGCal(endTime)}`,
      details: description,
      location: location
    });

    return `https://calendar.google.com/calendar/render?${params.toString()}`;
  }

  try {
    const xmlText = await fetchFirstWorking(candidates, 'schedule');
    const doc = new DOMParser().parseFromString(xmlText, 'text/xml');
    const parseErr = doc.querySelector('parsererror');

    if (parseErr) {
      status('shows.xml parser error â€” check console');
      console.error('[schedule] parsererror:', parseErr.textContent);
      container.innerHTML = '<p style="text-align:center;font-weight:600">Problem parsing <code>shows.xml</code>.</p>';
      return;
    }

    const nodes = [...doc.querySelectorAll('shows > show')];
    if (!nodes.length) {
      status('shows.xml loaded but contained 0 <show> nodes');
      container.innerHTML = '<p style="text-align:center;font-weight:600">No shows found in <code>shows.xml</code>.</p>';
      return;
    }

    const shows = nodes
      .filter(show => show.querySelector('verified')?.textContent?.trim().toLowerCase() === 'yes')
      .map(show => {
        const datetimeStr = show.querySelector('datetime')?.textContent?.trim() || '';
        const datetimeendStr = show.querySelector('datetimeend')?.textContent?.trim() || '';
        const appraisalStr = show.querySelector('appraisal')?.textContent?.trim() || '';
        const o = {
          type: show.getAttribute('type')?.trim() || '',
          datetime: datetimeStr,
          datetimeend: datetimeendStr,
          theme: show.querySelector('theme')?.textContent?.trim() || '',
          venue: show.querySelector('venue')?.textContent?.trim() || '',
          location: show.querySelector('location')?.textContent?.trim() || '',
          address: show.querySelector('address')?.textContent?.trim() || '',
          watch: show.querySelector('watch')?.textContent?.trim() || '',
          addtocalendar: show.querySelector('addtocalendar')?.textContent?.trim() || '',
          appraisal: appraisalStr,
          appraisalTimes: parseAppraisalTimes(appraisalStr),
          icon: show.querySelector('icon')?.textContent?.trim() || ''
        };
        o.start = parseUTCDateTime(o.datetime);
        o.end = parseUTCDateTime(o.datetimeend);
        if (!o.start) o._parseError = `Bad datetime: "${o.datetime}"`;
        return o;
      });

    if (shows.every(s => !s.start)) {
      status('All shows failed datetime parsing â€” see console');
      console.table(shows.map(s => ({ datetime: s.datetime, error: s._parseError || null })));
      container.innerHTML = '<p style="text-align:center;font-weight:600;grid-column:1/-1;font-size:1.2rem;">More Shows Coming Soon</p>';
      return;
    }

    const now = new Date();
    const upcoming = shows.filter(s => s.start && s.start >= now).sort((a, b) => a.start - b.start);
    const past = shows.filter(s => s.start && s.start < now).sort((a, b) => b.start - a.start);
    const sorted = [...upcoming, ...past];

    container.innerHTML = sorted.map(s => {
      const isPast = s.start < now;
      const accentColor = s.type === 'stage' ? '#FF3B3B' : '#4A90E2';
      const typeLabel = s.type === 'stage' ? 'Stage' : 'Screen';
      const mapsLink = s.address ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(s.address)}` : '';
      const watchUrl = s.watch || WATCH_URL;
      const calUrl = makeGoogleCalendarLink(s);

      return `
        <div class="show-item" style="
          display: grid;
          grid-template-columns: ${s.icon ? '80px ' : ''}120px 1fr auto;
          gap: 2rem;
          padding: 2rem 0;
          border-bottom: 1px solid #e0e0e0;
          ${isPast ? 'opacity: 0.4;' : ''}
        ">
          ${s.icon ? `
          <!-- Icon Column -->
          <div class="show-icon" style="display: flex; align-items: center; justify-content: center;">
            <img src="${s.icon}" style="width: 60px; height: 60px; object-fit: contain; display: block; cursor: pointer;" onclick="openImageLightbox('${s.icon}')" onerror="this.parentElement.style.display='none'">
          </div>
          ` : ''}

          <!-- Date Column -->
          <div class="show-date" style="text-align: left;">
            <div style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 2.5rem; font-weight: 700; line-height: 1; color: #2C2C2C; letter-spacing: -1px;">
              ${s.start.toLocaleDateString('en-US', { day: 'numeric' })}
            </div>
            <div style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 0.875rem; font-weight: 400; color: #666; text-transform: uppercase; margin-top: 0.25rem; letter-spacing: 0.5px;">
              ${s.start.toLocaleDateString('en-US', { month: 'short' })}
            </div>
            <div style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 0.75rem; font-weight: 400; color: #999; margin-top: 0.5rem;">
              ${fmtTime(s.start)}
            </div>
          </div>

          <!-- Info Column -->
          <div class="show-info" style="display: flex; flex-direction: column; gap: 0.5rem;">
            <div style="display: flex; align-items: baseline; gap: 0.75rem; flex-wrap: wrap;">
              <h3 style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 1.25rem; font-weight: 700; margin: 0; color: #2C2C2C; letter-spacing: -0.25px;">
                ${s.theme || 'SOLD OUT! Comedy'}
              </h3>
              <span style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 0.75rem; font-weight: 500; color: ${accentColor}; text-transform: uppercase; letter-spacing: 0.5px;">
                ${typeLabel}
              </span>
            </div>
            ${s.venue ? `
              <div style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 0.875rem; font-weight: 400; color: #666;">
                ${mapsLink ? `<a href="${mapsLink}" target="_blank" style="color: #666; text-decoration: none; border-bottom: 1px solid #ccc;">${s.venue}</a>` : s.venue}
              </div>
            ` : ''}
            ${s.location ? `
              <div style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 0.75rem; font-weight: 400; color: #999;">
                ${s.location}
              </div>
            ` : ''}
            ${s.type === 'stage' && s.appraisalTimes ? `
              <div style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 0.75rem; font-weight: 400; color: #999; margin-top: 0.25rem;">
                Appraisals: ${fmtTime(s.appraisalTimes.start, false)}â€“${fmtTime(s.appraisalTimes.end, false)}
              </div>
            ` : ''}
          </div>

          <!-- Action Column -->
          <div class="show-actions" style="display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end; justify-content: center;">
            <a href="${calUrl}" target="_blank" style="
              font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
              font-size: 0.75rem;
              font-weight: 500;
              color: #2C2C2C;
              text-decoration: none;
              border: 1px solid #2C2C2C;
              padding: 0.5rem 1rem;
              text-transform: uppercase;
              letter-spacing: 0.5px;
              transition: all 0.2s;
              white-space: nowrap;
              text-align: center;
              ${isPast ? 'opacity: 0.3; pointer-events: none;' : ''}
            " onmouseover="this.style.background='#2C2C2C'; this.style.color='white';" onmouseout="this.style.background='transparent'; this.style.color='#2C2C2C';">
              Add to Calendar
            </a>
            <a href="${isPast ? 'https://www.youtube.com/playlist?list=PL3og3QprCN4O6pIv2dCuB-MxCsQ0oj0eW' : watchUrl}" target="_blank" style="
              font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
              font-size: 0.75rem;
              font-weight: 500;
              color: white;
              background: #2C2C2C;
              text-decoration: none;
              border: 1px solid #2C2C2C;
              padding: 0.5rem 1rem;
              text-transform: uppercase;
              letter-spacing: 0.5px;
              transition: all 0.2s;
              white-space: nowrap;
              text-align: center;
            " onmouseover="this.style.background='white'; this.style.color='#2C2C2C';" onmouseout="this.style.background='#2C2C2C'; this.style.color='white';">
              ${isPast ? 'Watch Rerun' : 'Watch Live'}
            </a>
          </div>
        </div>
      `;
    }).join('');

    const bad = shows.filter(s => s._parseError);
    if (bad.length) {
      status(`Rendered ${sorted.length} shows â€¢ ${bad.length} had datetime issues (see console)`);
      console.table(bad.map(s => ({ datetime: s.datetime, error: s._parseError })));
    } else {
      status(`Rendered ${sorted.length} shows`);
    }

  } catch (err) {
    status('Failed to load schedule (see console)');
    console.error('[schedule] load failed:', err);
    container.innerHTML = '<p style="text-align:center;font-weight:600">More Shows Coming Soon</p>';
  }
}

/* ================================================
   IMAGE LIGHTBOX (Click to zoom show icons)
   ================================================ */

/**
 * Initializes the image lightbox/zoom functionality
 * Allows clicking show icons to view them full-screen
 */
function initImageLightbox() {
  const lightbox = document.getElementById('imageLightbox');
  const lightboxImg = lightbox.querySelector('img');

  if (!lightbox || !lightboxImg) return;

  // Close lightbox when clicking anywhere on the overlay
  lightbox.addEventListener('click', () => {
    lightbox.classList.remove('active');
    document.body.style.overflow = ''; // Re-enable scrolling
  });

  // Close lightbox with ESC key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && lightbox.classList.contains('active')) {
      lightbox.classList.remove('active');
      document.body.style.overflow = '';
    }
  });

  /**
   * Global function to open lightbox (called from inline onclick handlers)
   * @param {string} src - Image URL to display
   */
  window.openImageLightbox = (src) => {
    lightboxImg.src = src;
    lightbox.classList.add('active');
    document.body.style.overflow = 'hidden'; // Prevent background scrolling
  };
}

/* ================================================
   CONSIGNMENT GUIDELINES MODAL
   ================================================ */

/**
 * Initializes the consignment guidelines modal popup
 * Shows terms and conditions when footer link is clicked
 */
function initConsignmentModal() {
  const modal = document.getElementById('consignmentModal');
  const openLink = document.getElementById('consignmentGuidelinesLink');
  const closeBtn = document.getElementById('closeModal');

  if (!modal || !openLink || !closeBtn) return;

  // Open modal when "CONSIGNMENT GUIDELINES" link is clicked
  openLink.addEventListener('click', (e) => {
    e.preventDefault();
    modal.classList.add('active');
    document.body.style.overflow = 'hidden'; // Prevent background scrolling
  });

  // Close modal via X button
  closeBtn.addEventListener('click', () => {
    modal.classList.remove('active');
    document.body.style.overflow = '';
  });

  // Close modal when clicking outside the content (on the overlay)
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.classList.remove('active');
      document.body.style.overflow = '';
    }
  });

  // Close modal with ESC key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal.classList.contains('active')) {
      modal.classList.remove('active');
      document.body.style.overflow = '';
    }
  });
}

/* ================================================
   VIDEO UNMUTE BUTTON
   ================================================ */

/**
 * Initializes the mute/unmute toggle button for the comic frame video
 */
function initVideoUnmuteButton() {
  const videoElement = document.getElementById('comicFrameVideo');
  const unmuteBtn = document.getElementById('videoUnmuteBtn');

  if (!videoElement || !unmuteBtn) return;

  // Toggle mute/unmute when button is clicked
  unmuteBtn.addEventListener('click', () => {
    videoElement.muted = !videoElement.muted;

    // Update button icon based on mute state
    if (videoElement.muted) {
      unmuteBtn.textContent = 'ðŸ”‡'; // Muted icon
      unmuteBtn.setAttribute('aria-label', 'Unmute video');
    } else {
      unmuteBtn.textContent = 'ðŸ”Š'; // Unmuted icon
      unmuteBtn.setAttribute('aria-label', 'Mute video');
    }
  });
}

/* ================================================
   RANDOM VIDEO LOADER
   ================================================ */

/**
 * Loads a random video from the web/videos directory
 * Dynamically fetches the list of available videos
 */
async function loadRandomVideo() {
  const videoElement = document.getElementById('comicFrameVideo');
  if (!videoElement) return;

  const status = makeStatusLine(videoElement, 'random-video');

  // Check if running from file:// protocol
  if (location.protocol === 'file:') {
    status('Cannot load videos over file:// â€” run a local server (e.g., "npx serve").');
    return;
  }

  try {
    // Try multiple paths to find videos.xml
    const candidates = [
      'web/videos.xml',
      './videos.xml',
      '../web/videos.xml'
    ];

    const xmlText = await fetchFirstWorking(candidates, 'videos');
    const doc = new DOMParser().parseFromString(xmlText, 'text/xml');
    const parseErr = doc.querySelector('parsererror');

    if (parseErr) {
      status('videos.xml parser error â€” check console');
      console.error('[videos] parsererror:', parseErr.textContent);
      return;
    }

    // Extract all video file paths
    const videos = [...doc.querySelectorAll('videos > video')]
      .map(n => n.textContent?.trim())
      .filter(Boolean);

    if (!videos.length) {
      status('videos.xml loaded, but no <video> items found');
      return;
    }

    // Select a random video
    const randomVideo = videos[Math.floor(Math.random() * videos.length)];

    // Set the video source
    videoElement.src = randomVideo;

    // Load and play
    videoElement.load();
    videoElement.play().catch(err => {
      console.log('[comic-frame] Autoplay prevented:', err);
    });

    status(`Loaded random video from ${videos.length} options`);
  } catch (err) {
    status('Failed to load videos (see console)');
    console.error('[videos] load failed:', err);
  }
}
</script>
</body>
</html>
